---
image: docker:stable

services:
- docker:dind

.docker_login_gitlab: &docker_login_gitlab |
  echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

.docker_login_dockerhub: &docker_login_dockerhub |
  echo "$CI_DOCKER_REGISTRY_PASSWORD" | docker login -u "$CI_DOCKER_REGISTRY_USER" --password-stdin "$CI_DOCKER_REGISTRY"

stages:
- build
- verify

build-master-gitlab:
  stage: build
  script:
  - *docker_login_gitlab
  - docker build -f build/Dockerfile --pull -t "$CI_REGISTRY_IMAGE:latest" .
  - docker push "$CI_REGISTRY_IMAGE"
  only:
    refs:
    - master

build-master-dockerhub:
  stage: build
  script:
  - *docker_login_dockerhub
  - docker build -f build/Dockerfile --pull -t "$CI_DOCKER_REGISTRY_IMAGE:latest" .
  - docker push "$CI_DOCKER_REGISTRY_IMAGE"
  only:
    refs:
    - master

build-dockerhub:
  stage: build
  script:
  - *docker_login_dockerhub
  - docker build -f build/Dockerfile --pull -t "$CI_DOCKER_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME" .
  - docker push "$CI_DOCKER_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME"
  except:
    refs:
    - master

build-gitlab:
  stage: build
  script:
  - *docker_login_gitlab
  - docker build -f build/Dockerfile --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME" .
  - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME"
  except:
    refs:
    - master

verify-services:
  stage: verify
  image: google/cloud-sdk:latest
  script:
    - apt-get update && apt-get install -y curl
    - kubectl config set-context --current --namespace=rating
    - nohup ./hack/forward-api &
    - nohup ./hack/forward-prometheus &
    - nohup ./hack/forward-grafana &
    - sleep 5 # wait for port-forwarding to establish
    - |
      API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5012)
      if [ "$API_RESPONSE" -ne 200 ]; then
        echo "Failed to access API on port 5012. Status code: $API_RESPONSE"
        exit 1
      fi
    - |
      PROMETHEUS_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9090)
      if [ "$PROMETHEUS_RESPONSE" -ne 200 ]; then
        echo "Failed to access Prometheus on port 9090. Status code: $PROMETHEUS_RESPONSE"
        exit 1
      fi
    - |
      GRAFANA_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
      if [ "$GRAFANA_RESPONSE" -ne 200 ]; then
        echo "Failed to access Grafana on port 3000. Status code: $GRAFANA_RESPONSE"
        exit 1
      fi
  only:
    refs:
    - v3-test
